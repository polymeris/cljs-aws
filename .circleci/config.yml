# Clojure CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-clojure/ for more details
#
version: 2
jobs:
  build:
    docker:
    - image: circleci/clojure:lein-node
    working_directory: ~/repo
    steps:
    - checkout
    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "project.clj" }}
        - v1-dependencies-
    - run: lein deps
    - save_cache:
        paths:
        - ~/.m2
        key: v1-dependencies-{{ checksum "project.clj" }}
    - run: lein v
    - run: lein download-deps
    - run: lein install
    - persist_to_workspace:
        root: ..
        paths:
        - repo
        - .m2

  unit-test-node:
    docker:
    - image: circleci/clojure:lein-node
    working_directory: ~/repo
    steps:
    - attach_workspace:
        at: ..
    - run: lein deps
    - run: lein test-node

  unit-test-phantom:
    docker:
    - image: circleci/clojure:lein-node-browsers-legacy
    working_directory: ~/repo
    steps:
    - attach_workspace:
        at: ..
    - run: lein deps
    - run: lein test-phantom

  test-examples-node:
    docker:
    - image: circleci/clojure:lein-node
    - image: localstack/localstack
    working_directory: ~/repo/node-examples
    environment:
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: AKIAIOSFODNN7EXAMPLE
      AWS_SECRET_ACCESS_KEY: je7MtGbClwBF/2Zp9Utk/h3yCo8nvbEXAMPLEKEY
    steps:
    - attach_workspace:
        at: ../..
    - run: lein deps
    - run: lein cljsbuild once cloudwatch
    - run: lein cljsbuild once dynamodb
    - run: lein cljsbuild once kinesis
    - run: lein cljsbuild once route-53
    - run: lein cljsbuild once s3
    - run: lein cljsbuild once sns
    - run: lein cljsbuild once sqs
    # Not running CloudWatch example, because localstack 500's
    #- run: AWS_ENDPOINT=http://localhost:4582 node target/cloudwatch.js
    - run: AWS_ENDPOINT=http://localhost:4570 node target/dynamodb.js
    - run: AWS_ENDPOINT=http://localhost:4568 node target/kinesis.js
    - run: AWS_ENDPOINT=http://localhost:4580 node target/route-53.js
    - run: AWS_ENDPOINT=http://localhost:4572 node target/s3.js
    - run: AWS_ENDPOINT=http://localhost:4575 node target/sns.js
    - run: AWS_ENDPOINT=http://localhost:4576 node target/sqs.js

  build-examples-browser:
    docker:
    - image: circleci/clojure:lein-node
    working_directory: ~/repo/browser-examples
    steps:
    - attach_workspace:
        at: ../..
    - run: lein deps
    - run: lein cljsbuild once lambda

  deploy:
    docker:
    - image: circleci/clojure:lein-node
    working_directory: ~/repo
    steps:
    - checkout
    - run: lein download-deps
    - run: lein deploy clojars

workflows:
  version: 2
  build-test-deploy:
    jobs:
    - build:
        filters: {tags: {only: "/.*/"}}
    - unit-test-node:
        requires: [build]
        filters: {tags: {only: "/.*/"}}
    - unit-test-phantom:
        requires: [build]
        filters: {tags: {only: "/.*/"}}
    - test-examples-node:
        requires: [build]
        filters: {tags: {only: "/.*/"}}
    - build-examples-browser:
        requires: [build]
        filters: {tags: {only: "/.*/"}}
    - deploy:
        filters:
          tags: {only: "/v.*/"}
          branches: {only: deploy}
        requires:
        - unit-test-node
        - unit-test-phantom
        - test-examples-node
        - build-examples-browser
